class SandboxController < ApplicationController
  include SandboxHelper
  layout "sandbox"
  before_filter :pick_styles, :get_sandbox_files, except: [:echo_json, :echo_html, :infinite_scroll]
  before_filter :validate_doc_file, only: [:show, :embed_code]

  # GET /sandbox
  #
  # main welcome screen
  def index
    render_markdown("#{SANDBOX_DOCS_ABOUT}overview.md");
  end


  # GET /sandbox/about/:file
  #
  # About pages. Getting started, license, etc. All files are markdown
  def about
    @file = params[:file]
    file = "#{SANDBOX_DOCS_ABOUT}#{@file}.md"

    # verify that the user is requesting a markdown file we actually want to serve. Because security.
    unless render_markdown(file)
      redirect_to sandbox_path, alert: "File not found (#{params[:file]}) in #{SANDBOX_DOCS_ABOUT}."
    end
  end

  # GET /sandbox/:section/:file[.html.erb OR .md]
  # GET /sandbox/:section/:directory/:file[.html.erb OR .md]
  #
  # example: /sandbox/JavaScript/Boostrap_JS/alerts
  def show
    sleep params[:sleep].to_i # optionally allow this response to be delayed for demo purposes
    # if they are looking for a file in a directory
    if params[:dir].present?
      path = "#{SANDBOX_DOCS_ROOT}#{SANDBOX_DOCS_PATH}#{@section}/#{params[:dir]}/#{@section_files[params[:dir]][params[:file]]}"
      render path unless render_markdown("#{path}.md")
    # else render the file itself (in the root of the section - i.e. docs/JavaScript/foo.html.erb or .md)
    else
      render @section_files[params[:file]] unless render_markdown("app/views/#{@section_files[params[:file]]}.md")
    end
  end

  # GET /sandbox/block/:section/:dir/:file/:index
  #
  # Renders the code block of a specific embed code block from a docs page as a stand alone page.
  def embed_code
    # determine the path for the desired file
    if params[:dir].present?
      path = "#{SANDBOX_DOCS_PATH}#{@section}/#{params[:dir]}/#{@section_files[params[:dir]][params[:file]]}"
    else
      path = "#{SANDBOX_DOCS_PATH}#{@section}/#{@section_files[params[:file]]}"
    end
    # read the file
    body = read_html(path)
    begin
      # find the .example-blocks on the page, grab the one in the specified index,
      # get it's first .tab-pane and read the html
      @code = body.css('.example-block')[params[:index].to_i]
                  .css('.tab-pane').first.to_html.html_safe
    rescue
      redirect_to sandbox_dir_file_path(
        section: params[:section],
        dir: params[:dir],
        file: params[:file]
      ), alert: "Could not find example block specified."
    end
  end

  # GET /sandbox/codeblock_sizes/:section/:dir/:file/:index
  #
  # A page w/ several iframes containing a codeblock (the nth codeblock specified by
  # params[:index] from the specified section/dir/file) to show how a specific example
  # reacts in different document sizes
  def codeblock_sizes
  end

  # GET  'sandbox/echo_json'
  # POST 'sandbox/echo_json'
  #
  # Returns the json object specified in the `data` posted as JSON; used for ajax demos and the like.
  def echo_json
    sleep 1 # to give the appearance of an actual request; so spinner shows, etc.
    render json: params[:data].to_json
  end

  # GET  'sandbox/echo_html'
  # POST 'sandbox/echo_html'
  #
  # Returns the html specified in the `html` posted; used for ajax demos and the like.
  def echo_html
    sleep 1 # to give the appearance of an actual request; so spinner shows, etc.
    render text: params[:html]
  end

  # GET '/sandbox/chart/:type'
  #
  # Returns a sample chart data formatted per HighCharts structure.
  def get_chart
    charts = {
      'three_lines' => '{"title":{"text":"<span>Three Lines</span>"},"subtitle":{"text":"<span>One, Two, and Three</span>"},"tooltip":{"valuePrefix":null,"valueSuffix":null},"yAxis":{"title":{"text":"Stuff"}},"series":[{"name":"One","id":"total_users","data":[{"x":1372143600000,"y":3608},{"x":1372230000000,"y":3644},{"x":1372316400000,"y":3674},{"x":1372402800000,"y":3713},{"x":1372489200000,"y":3730},{"x":1372575600000,"y":3743},{"x":1372662000000,"y":3971},{"x":1372748400000,"y":4073},{"x":1372834800000,"y":4117},{"x":1372921200000,"y":4147},{"x":1373007600000,"y":4176},{"x":1373094000000,"y":4202},{"x":1373180400000,"y":4214},{"x":1373266800000,"y":4279},{"x":1373353200000,"y":4322},{"x":1373439600000,"y":4369},{"x":1373526000000,"y":4407},{"x":1373612400000,"y":4447},{"x":1373698800000,"y":4472},{"x":1373785200000,"y":4484},{"x":1373871600000,"y":4514},{"x":1373958000000,"y":4548},{"x":1374044400000,"y":4579},{"x":1374130800000,"y":4605},{"x":1374217200000,"y":4637},{"x":1374303600000,"y":4647},{"x":1374390000000,"y":4661},{"x":1374476400000,"y":4698},{"x":1374562800000,"y":4729},{"x":1374649200000,"y":4769},{"x":1374735600000,"y":4810},{"x":1374822000000,"y":4839},{"x":1374908400000,"y":4862},{"x":1374994800000,"y":4881},{"x":1375081200000,"y":4942},{"x":1375167600000,"y":4998},{"x":1375254000000,"y":5043},{"x":1375340400000,"y":5100},{"x":1375426800000,"y":5160},{"x":1375513200000,"y":5182},{"x":1375599600000,"y":5220},{"x":1375686000000,"y":5276},{"x":1375772400000,"y":5323},{"x":1375858800000,"y":5366},{"x":1375945200000,"y":5409},{"x":1376031600000,"y":5484},{"x":1376118000000,"y":5518},{"x":1376204400000,"y":5542},{"x":1376290800000,"y":5586},{"x":1376377200000,"y":5628},{"x":1376463600000,"y":5674},{"x":1376550000000,"y":5714},{"x":1376636400000,"y":5747},{"x":1376722800000,"y":5770},{"x":1376809200000,"y":5794},{"x":1376895600000,"y":5837},{"x":1376982000000,"y":5889},{"x":1377068400000,"y":5925},{"x":1377154800000,"y":5962},{"x":1377241200000,"y":6001},{"x":1377327600000,"y":6023},{"x":1377414000000,"y":6050},{"x":1377500400000,"y":6083},{"x":1377586800000,"y":6129},{"x":1377673200000,"y":6170},{"x":1377759600000,"y":6198},{"x":1377846000000,"y":6238},{"x":1377932400000,"y":6254},{"x":1378018800000,"y":6284},{"x":1378105200000,"y":6317},{"x":1378191600000,"y":6359},{"x":1378278000000,"y":6398},{"x":1378364400000,"y":6436},{"x":1378450800000,"y":6464},{"x":1378537200000,"y":6487},{"x":1378623600000,"y":6507},{"x":1378710000000,"y":6507},{"x":1378796400000,"y":6507},{"x":1378882800000,"y":6507},{"x":1378969200000,"y":6507},{"x":1379055600000,"y":6507},{"x":1379142000000,"y":6507},{"x":1379228400000,"y":6507},{"x":1379314800000,"y":6507},{"x":1379401200000,"y":6507},{"x":1379487600000,"y":6507},{"x":1379574000000,"y":6507},{"x":1379660400000,"y":6507},{"x":1379746800000,"y":6507},{"x":1379833200000,"y":6507},{"x":1379919600000,"y":6507}]},{"name":"Two","id":"linked_users","data":[{"x":1372143600000,"y":2216},{"x":1372230000000,"y":2246},{"x":1372316400000,"y":2271},{"x":1372402800000,"y":2299},{"x":1372489200000,"y":2312},{"x":1372575600000,"y":2321},{"x":1372662000000,"y":2483},{"x":1372748400000,"y":2559},{"x":1372834800000,"y":2594},{"x":1372921200000,"y":2612},{"x":1373007600000,"y":2637},{"x":1373094000000,"y":2655},{"x":1373180400000,"y":2665},{"x":1373266800000,"y":2711},{"x":1373353200000,"y":2744},{"x":1373439600000,"y":2786},{"x":1373526000000,"y":2814},{"x":1373612400000,"y":2848},{"x":1373698800000,"y":2863},{"x":1373785200000,"y":2868},{"x":1373871600000,"y":2886},{"x":1373958000000,"y":2918},{"x":1374044400000,"y":2941},{"x":1374130800000,"y":2966},{"x":1374217200000,"y":2993},{"x":1374303600000,"y":3001},{"x":1374390000000,"y":3011},{"x":1374476400000,"y":3039},{"x":1374562800000,"y":3070},{"x":1374649200000,"y":3097},{"x":1374735600000,"y":3132},{"x":1374822000000,"y":3157},{"x":1374908400000,"y":3170},{"x":1374994800000,"y":3181},{"x":1375081200000,"y":3224},{"x":1375167600000,"y":3265},{"x":1375254000000,"y":3303},{"x":1375340400000,"y":3348},{"x":1375426800000,"y":3383},{"x":1375513200000,"y":3397},{"x":1375599600000,"y":3415},{"x":1375686000000,"y":3448},{"x":1375772400000,"y":3484},{"x":1375858800000,"y":3516},{"x":1375945200000,"y":3545},{"x":1376031600000,"y":3592},{"x":1376118000000,"y":3602},{"x":1376204400000,"y":3622},{"x":1376290800000,"y":3657},{"x":1376377200000,"y":3691},{"x":1376463600000,"y":3724},{"x":1376550000000,"y":3752},{"x":1376636400000,"y":3777},{"x":1376722800000,"y":3793},{"x":1376809200000,"y":3809},{"x":1376895600000,"y":3842},{"x":1376982000000,"y":3881},{"x":1377068400000,"y":3921},{"x":1377154800000,"y":3947},{"x":1377241200000,"y":3979},{"x":1377327600000,"y":3989},{"x":1377414000000,"y":4004},{"x":1377500400000,"y":4032},{"x":1377586800000,"y":4063},{"x":1377673200000,"y":4088},{"x":1377759600000,"y":4112},{"x":1377846000000,"y":4134},{"x":1377932400000,"y":4145},{"x":1378018800000,"y":4164},{"x":1378105200000,"y":4184},{"x":1378191600000,"y":4219},{"x":1378278000000,"y":4250},{"x":1378364400000,"y":4280},{"x":1378450800000,"y":4293},{"x":1378537200000,"y":4309},{"x":1378623600000,"y":4317},{"x":1378710000000,"y":4317},{"x":1378796400000,"y":4317},{"x":1378882800000,"y":4317},{"x":1378969200000,"y":4317},{"x":1379055600000,"y":4317},{"x":1379142000000,"y":4317},{"x":1379228400000,"y":4317},{"x":1379314800000,"y":4317},{"x":1379401200000,"y":4317},{"x":1379487600000,"y":4317},{"x":1379574000000,"y":4317},{"x":1379660400000,"y":4317},{"x":1379746800000,"y":4317},{"x":1379833200000,"y":4317},{"x":1379919600000,"y":4317}]},{"name":"Three","id":"transacted_users","data":[{"x":1372143600000,"y":1453},{"x":1372230000000,"y":1482},{"x":1372316400000,"y":1513},{"x":1372402800000,"y":1540},{"x":1372489200000,"y":1553},{"x":1372575600000,"y":1561},{"x":1372662000000,"y":1605},{"x":1372748400000,"y":1654},{"x":1372834800000,"y":1705},{"x":1372921200000,"y":1713},{"x":1373007600000,"y":1733},{"x":1373094000000,"y":1744},{"x":1373180400000,"y":1751},{"x":1373266800000,"y":1798},{"x":1373353200000,"y":1842},{"x":1373439600000,"y":1879},{"x":1373526000000,"y":1914},{"x":1373612400000,"y":1943},{"x":1373698800000,"y":1956},{"x":1373785200000,"y":1959},{"x":1373871600000,"y":1991},{"x":1373958000000,"y":2016},{"x":1374044400000,"y":2037},{"x":1374130800000,"y":2072},{"x":1374217200000,"y":2099},{"x":1374303600000,"y":2104},{"x":1374390000000,"y":2113},{"x":1374476400000,"y":2142},{"x":1374562800000,"y":2173},{"x":1374649200000,"y":2204},{"x":1374735600000,"y":2231},{"x":1374822000000,"y":2255},{"x":1374908400000,"y":2264},{"x":1374994800000,"y":2268},{"x":1375081200000,"y":2305},{"x":1375167600000,"y":2341},{"x":1375254000000,"y":2375},{"x":1375340400000,"y":2409},{"x":1375426800000,"y":2441},{"x":1375513200000,"y":2448},{"x":1375599600000,"y":2456},{"x":1375686000000,"y":2499},{"x":1375772400000,"y":2525},{"x":1375858800000,"y":2546},{"x":1375945200000,"y":2575},{"x":1376031600000,"y":2602},{"x":1376118000000,"y":2612},{"x":1376204400000,"y":2621},{"x":1376290800000,"y":2658},{"x":1376377200000,"y":2674},{"x":1376463600000,"y":2705},{"x":1376550000000,"y":2723},{"x":1376636400000,"y":2740},{"x":1376722800000,"y":2753},{"x":1376809200000,"y":2761},{"x":1376895600000,"y":2790},{"x":1376982000000,"y":2822},{"x":1377068400000,"y":2850},{"x":1377154800000,"y":2876},{"x":1377241200000,"y":2899},{"x":1377327600000,"y":2916},{"x":1377414000000,"y":2925},{"x":1377500400000,"y":2947},{"x":1377586800000,"y":2972},{"x":1377673200000,"y":2991},{"x":1377759600000,"y":3016},{"x":1377846000000,"y":3040},{"x":1377932400000,"y":3048},{"x":1378018800000,"y":3059},{"x":1378105200000,"y":3067},{"x":1378191600000,"y":3093},{"x":1378278000000,"y":3114},{"x":1378364400000,"y":3149},{"x":1378450800000,"y":3163},{"x":1378537200000,"y":3171},{"x":1378623600000,"y":3182},{"x":1378710000000,"y":3182},{"x":1378796400000,"y":3182},{"x":1378882800000,"y":3182},{"x":1378969200000,"y":3182},{"x":1379055600000,"y":3182},{"x":1379142000000,"y":3182},{"x":1379228400000,"y":3182},{"x":1379314800000,"y":3182},{"x":1379401200000,"y":3182},{"x":1379487600000,"y":3182},{"x":1379574000000,"y":3182},{"x":1379660400000,"y":3182},{"x":1379746800000,"y":3182},{"x":1379833200000,"y":3182},{"x":1379919600000,"y":3182}]},{"type":"flags","data":[],"width":14,"height":24,"stackDistance":20,"shadow":false,"cursor":"pointer","shape":"url(/assets/chart-marker.png)","y":-30,"onSeries":null}],"xAxis":{"type":"datetime","maxZoom":1209600000}}',
      'columns' => '{"title":{"text":"<span>Columns</span>"},"subtitle":{"text":null},"tooltip":{"valuePrefix":null,"valueSuffix":null},"yAxis":{"title":{"text":"Stuff"}},"series":[{"name":"Stuff","data":[1176,931,685,404,241]}],"xAxis":{"categories":["0-20%","20-40%","40-60%","60-80%","80+%"]}}',
      'column_comparison' => '{"title":{"text":"<span>Column Comparison</span>"},"subtitle":{"text":"<span>Some Stuff Compared</span>"},"tooltip":{"valuePrefix":null,"valueSuffix":null},"yAxis":{"title":{"text":"One Thing"}},"series":[{"name":"One Thing","id":"batch","data":[{"x":1365836400000,"y":1},{"x":1365922800000,"y":0},{"x":1366009200000,"y":18},{"x":1366095600000,"y":14},{"x":1366182000000,"y":12},{"x":1366268400000,"y":15},{"x":1366354800000,"y":7},{"x":1366441200000,"y":1},{"x":1366527600000,"y":2},{"x":1366614000000,"y":19},{"x":1366700400000,"y":15},{"x":1366786800000,"y":10},{"x":1366873200000,"y":18},{"x":1366959600000,"y":14},{"x":1367046000000,"y":1},{"x":1367132400000,"y":0},{"x":1367218800000,"y":10},{"x":1367305200000,"y":12},{"x":1367391600000,"y":10},{"x":1367478000000,"y":9},{"x":1367564400000,"y":12},{"x":1367650800000,"y":5},{"x":1367737200000,"y":0},{"x":1367823600000,"y":21},{"x":1367910000000,"y":15},{"x":1367996400000,"y":14},{"x":1368082800000,"y":18},{"x":1368169200000,"y":15},{"x":1368255600000,"y":0},{"x":1368342000000,"y":3},{"x":1368428400000,"y":17},{"x":1368514800000,"y":15},{"x":1368601200000,"y":12},{"x":1368687600000,"y":12},{"x":1368774000000,"y":7},{"x":1368860400000,"y":2},{"x":1368946800000,"y":6},{"x":1369033200000,"y":17},{"x":1369119600000,"y":17},{"x":1369206000000,"y":13},{"x":1369292400000,"y":12},{"x":1369378800000,"y":4},{"x":1369465200000,"y":0},{"x":1369551600000,"y":1},{"x":1369638000000,"y":1},{"x":1369724400000,"y":9},{"x":1369810800000,"y":11},{"x":1369897200000,"y":7},{"x":1369983600000,"y":8},{"x":1370070000000,"y":1},{"x":1370156400000,"y":0},{"x":1370242800000,"y":7},{"x":1370329200000,"y":16},{"x":1370415600000,"y":10},{"x":1370502000000,"y":17},{"x":1370588400000,"y":10},{"x":1370674800000,"y":6},{"x":1370761200000,"y":1},{"x":1370847600000,"y":21},{"x":1370934000000,"y":16},{"x":1371020400000,"y":12},{"x":1371106800000,"y":14}],"borderColor":"#666","color":"#6690c6"},{"name":"Another Thing","id":"realtime","data":[{"x":1365836400000,"y":12},{"x":1365922800000,"y":15},{"x":1366009200000,"y":16},{"x":1366095600000,"y":21},{"x":1366182000000,"y":20},{"x":1366268400000,"y":22},{"x":1366354800000,"y":28},{"x":1366441200000,"y":20},{"x":1366527600000,"y":11},{"x":1366614000000,"y":15},{"x":1366700400000,"y":22},{"x":1366786800000,"y":21},{"x":1366873200000,"y":17},{"x":1366959600000,"y":25},{"x":1367046000000,"y":17},{"x":1367132400000,"y":12},{"x":1367218800000,"y":24},{"x":1367305200000,"y":22},{"x":1367391600000,"y":23},{"x":1367478000000,"y":21},{"x":1367564400000,"y":26},{"x":1367650800000,"y":17},{"x":1367737200000,"y":13},{"x":1367823600000,"y":20},{"x":1367910000000,"y":24},{"x":1367996400000,"y":23},{"x":1368082800000,"y":35},{"x":1368169200000,"y":39},{"x":1368255600000,"y":19},{"x":1368342000000,"y":17},{"x":1368428400000,"y":23},{"x":1368514800000,"y":20},{"x":1368601200000,"y":30},{"x":1368687600000,"y":29},{"x":1368774000000,"y":45},{"x":1368860400000,"y":26},{"x":1368946800000,"y":25},{"x":1369033200000,"y":27},{"x":1369119600000,"y":29},{"x":1369206000000,"y":27},{"x":1369292400000,"y":33},{"x":1369378800000,"y":43},{"x":1369465200000,"y":17},{"x":1369551600000,"y":18},{"x":1369638000000,"y":22},{"x":1369724400000,"y":26},{"x":1369810800000,"y":35},{"x":1369897200000,"y":45},{"x":1369983600000,"y":56},{"x":1370070000000,"y":31},{"x":1370156400000,"y":40},{"x":1370242800000,"y":34},{"x":1370329200000,"y":47},{"x":1370415600000,"y":61},{"x":1370502000000,"y":58},{"x":1370588400000,"y":83},{"x":1370674800000,"y":41},{"x":1370761200000,"y":26},{"x":1370847600000,"y":78},{"x":1370934000000,"y":83},{"x":1371020400000,"y":77},{"x":1371106800000,"y":88}],"borderColor":"#666","color":"#446fa8"},{"name":"Total","color":"#000","type":"scatter","stack":"none1","linkedTo":"batch","data":[{"x":1365836400000,"y":13},{"x":1365922800000,"y":15},{"x":1366009200000,"y":34},{"x":1366095600000,"y":35},{"x":1366182000000,"y":32},{"x":1366268400000,"y":37},{"x":1366354800000,"y":35},{"x":1366441200000,"y":21},{"x":1366527600000,"y":13},{"x":1366614000000,"y":34},{"x":1366700400000,"y":37},{"x":1366786800000,"y":31},{"x":1366873200000,"y":35},{"x":1366959600000,"y":39},{"x":1367046000000,"y":18},{"x":1367132400000,"y":12},{"x":1367218800000,"y":34},{"x":1367305200000,"y":34},{"x":1367391600000,"y":33},{"x":1367478000000,"y":30},{"x":1367564400000,"y":38},{"x":1367650800000,"y":22},{"x":1367737200000,"y":13},{"x":1367823600000,"y":41},{"x":1367910000000,"y":39},{"x":1367996400000,"y":37},{"x":1368082800000,"y":53},{"x":1368169200000,"y":54},{"x":1368255600000,"y":19},{"x":1368342000000,"y":20},{"x":1368428400000,"y":40},{"x":1368514800000,"y":35},{"x":1368601200000,"y":42},{"x":1368687600000,"y":41},{"x":1368774000000,"y":52},{"x":1368860400000,"y":28},{"x":1368946800000,"y":31},{"x":1369033200000,"y":44},{"x":1369119600000,"y":46},{"x":1369206000000,"y":40},{"x":1369292400000,"y":45},{"x":1369378800000,"y":47},{"x":1369465200000,"y":17},{"x":1369551600000,"y":19},{"x":1369638000000,"y":23},{"x":1369724400000,"y":35},{"x":1369810800000,"y":46},{"x":1369897200000,"y":52},{"x":1369983600000,"y":64},{"x":1370070000000,"y":32},{"x":1370156400000,"y":40},{"x":1370242800000,"y":41},{"x":1370329200000,"y":63},{"x":1370415600000,"y":71},{"x":1370502000000,"y":75},{"x":1370588400000,"y":93},{"x":1370674800000,"y":47},{"x":1370761200000,"y":27},{"x":1370847600000,"y":99},{"x":1370934000000,"y":99},{"x":1371020400000,"y":89},{"x":1371106800000,"y":102}]}],"navigator":{"series":{"type":"areaspline","data":[{"x":1365836400000,"y":13},{"x":1365922800000,"y":15},{"x":1366009200000,"y":34},{"x":1366095600000,"y":35},{"x":1366182000000,"y":32},{"x":1366268400000,"y":37},{"x":1366354800000,"y":35},{"x":1366441200000,"y":21},{"x":1366527600000,"y":13},{"x":1366614000000,"y":34},{"x":1366700400000,"y":37},{"x":1366786800000,"y":31},{"x":1366873200000,"y":35},{"x":1366959600000,"y":39},{"x":1367046000000,"y":18},{"x":1367132400000,"y":12},{"x":1367218800000,"y":34},{"x":1367305200000,"y":34},{"x":1367391600000,"y":33},{"x":1367478000000,"y":30},{"x":1367564400000,"y":38},{"x":1367650800000,"y":22},{"x":1367737200000,"y":13},{"x":1367823600000,"y":41},{"x":1367910000000,"y":39},{"x":1367996400000,"y":37},{"x":1368082800000,"y":53},{"x":1368169200000,"y":54},{"x":1368255600000,"y":19},{"x":1368342000000,"y":20},{"x":1368428400000,"y":40},{"x":1368514800000,"y":35},{"x":1368601200000,"y":42},{"x":1368687600000,"y":41},{"x":1368774000000,"y":52},{"x":1368860400000,"y":28},{"x":1368946800000,"y":31},{"x":1369033200000,"y":44},{"x":1369119600000,"y":46},{"x":1369206000000,"y":40},{"x":1369292400000,"y":45},{"x":1369378800000,"y":47},{"x":1369465200000,"y":17},{"x":1369551600000,"y":19},{"x":1369638000000,"y":23},{"x":1369724400000,"y":35},{"x":1369810800000,"y":46},{"x":1369897200000,"y":52},{"x":1369983600000,"y":64},{"x":1370070000000,"y":32},{"x":1370156400000,"y":40},{"x":1370242800000,"y":41},{"x":1370329200000,"y":63},{"x":1370415600000,"y":71},{"x":1370502000000,"y":75},{"x":1370588400000,"y":93},{"x":1370674800000,"y":47},{"x":1370761200000,"y":27},{"x":1370847600000,"y":99},{"x":1370934000000,"y":99},{"x":1371020400000,"y":89},{"x":1371106800000,"y":102}]}},"xAxis":{"type":"datetime","maxZoom":1209600000}}',
      'column_comparison_with_negatives' => '{"title":{"text":"<span>Column Comparison With Negative Values</span>"},"subtitle":{"text":"<span>Stuff</span>"},"tooltip":{"valuePrefix":null,"valueSuffix":null},"yAxis":{"title":{"text":"Activity"}},"series":[{"name":"One Thing","data":[{"x":1365836400000,"y":2},{"x":1365922800000,"y":2},{"x":1366009200000,"y":4},{"x":1366095600000,"y":6},{"x":1366182000000,"y":10},{"x":1366268400000,"y":8},{"x":1366354800000,"y":3},{"x":1366441200000,"y":3},{"x":1366527600000,"y":3},{"x":1366614000000,"y":4},{"x":1366700400000,"y":8},{"x":1366786800000,"y":11},{"x":1366873200000,"y":8},{"x":1366959600000,"y":5},{"x":1367046000000,"y":0},{"x":1367132400000,"y":2},{"x":1367218800000,"y":7},{"x":1367305200000,"y":1},{"x":1367391600000,"y":8},{"x":1367478000000,"y":3},{"x":1367564400000,"y":6},{"x":1367650800000,"y":4},{"x":1367737200000,"y":4},{"x":1367823600000,"y":6},{"x":1367910000000,"y":9},{"x":1367996400000,"y":11},{"x":1368082800000,"y":6},{"x":1368169200000,"y":9},{"x":1368255600000,"y":4},{"x":1368342000000,"y":3},{"x":1368428400000,"y":5},{"x":1368514800000,"y":5},{"x":1368601200000,"y":5},{"x":1368687600000,"y":12},{"x":1368774000000,"y":3},{"x":1368860400000,"y":5},{"x":1368946800000,"y":4},{"x":1369033200000,"y":5},{"x":1369119600000,"y":7},{"x":1369206000000,"y":10},{"x":1369292400000,"y":10},{"x":1369378800000,"y":9},{"x":1369465200000,"y":3},{"x":1369551600000,"y":3},{"x":1369638000000,"y":1},{"x":1369724400000,"y":3},{"x":1369810800000,"y":6},{"x":1369897200000,"y":8},{"x":1369983600000,"y":11},{"x":1370070000000,"y":10},{"x":1370156400000,"y":5},{"x":1370242800000,"y":2},{"x":1370329200000,"y":2},{"x":1370415600000,"y":4},{"x":1370502000000,"y":3},{"x":1370588400000,"y":8},{"x":1370674800000,"y":8},{"x":1370761200000,"y":1},{"x":1370847600000,"y":3},{"x":1370934000000,"y":7},{"x":1371020400000,"y":6},{"x":1371106800000,"y":7}],"borderColor":"#666","color":"#4371A9"},{"name":"Another Thing","data":[{"x":1365836400000,"y":-1},{"x":1365922800000,"y":0},{"x":1366009200000,"y":-2},{"x":1366095600000,"y":-2},{"x":1366182000000,"y":-2},{"x":1366268400000,"y":-2},{"x":1366354800000,"y":-3},{"x":1366441200000,"y":0},{"x":1366527600000,"y":0},{"x":1366614000000,"y":-5},{"x":1366700400000,"y":-3},{"x":1366786800000,"y":-6},{"x":1366873200000,"y":-1},{"x":1366959600000,"y":-3},{"x":1367046000000,"y":0},{"x":1367132400000,"y":-1},{"x":1367218800000,"y":-2},{"x":1367305200000,"y":-6},{"x":1367391600000,"y":-4},{"x":1367478000000,"y":-7},{"x":1367564400000,"y":-2},{"x":1367650800000,"y":-1},{"x":1367737200000,"y":-1},{"x":1367823600000,"y":-3},{"x":1367910000000,"y":-1},{"x":1367996400000,"y":-3},{"x":1368082800000,"y":-2},{"x":1368169200000,"y":-2},{"x":1368255600000,"y":0},{"x":1368342000000,"y":0},{"x":1368428400000,"y":-3},{"x":1368514800000,"y":-4},{"x":1368601200000,"y":-1},{"x":1368687600000,"y":-3},{"x":1368774000000,"y":-1},{"x":1368860400000,"y":-1},{"x":1368946800000,"y":0},{"x":1369033200000,"y":0},{"x":1369119600000,"y":-4},{"x":1369206000000,"y":-4},{"x":1369292400000,"y":-2},{"x":1369378800000,"y":-3},{"x":1369465200000,"y":0},{"x":1369551600000,"y":0},{"x":1369638000000,"y":-1},{"x":1369724400000,"y":-3},{"x":1369810800000,"y":-2},{"x":1369897200000,"y":-5},{"x":1369983600000,"y":-5},{"x":1370070000000,"y":-1},{"x":1370156400000,"y":0},{"x":1370242800000,"y":-2},{"x":1370329200000,"y":-5},{"x":1370415600000,"y":-2},{"x":1370502000000,"y":-6},{"x":1370588400000,"y":-3},{"x":1370674800000,"y":-1},{"x":1370761200000,"y":-1},{"x":1370847600000,"y":-1},{"x":1370934000000,"y":-3},{"x":1371020400000,"y":-5},{"x":1371106800000,"y":-2}],"borderColor":"#666","color":"#89A648"},{"name":"Still Another","data":[{"x":1365836400000,"y":-2},{"x":1365922800000,"y":-3},{"x":1366009200000,"y":-2},{"x":1366095600000,"y":-3},{"x":1366182000000,"y":-3},{"x":1366268400000,"y":-5},{"x":1366354800000,"y":-1},{"x":1366441200000,"y":-5},{"x":1366527600000,"y":-2},{"x":1366614000000,"y":-1},{"x":1366700400000,"y":0},{"x":1366786800000,"y":-1},{"x":1366873200000,"y":-4},{"x":1366959600000,"y":-5},{"x":1367046000000,"y":-3},{"x":1367132400000,"y":0},{"x":1367218800000,"y":-2},{"x":1367305200000,"y":-2},{"x":1367391600000,"y":-5},{"x":1367478000000,"y":-2},{"x":1367564400000,"y":-5},{"x":1367650800000,"y":-1},{"x":1367737200000,"y":-2},{"x":1367823600000,"y":-3},{"x":1367910000000,"y":-2},{"x":1367996400000,"y":-4},{"x":1368082800000,"y":-4},{"x":1368169200000,"y":-5},{"x":1368255600000,"y":-3},{"x":1368342000000,"y":-4},{"x":1368428400000,"y":-4},{"x":1368514800000,"y":-2},{"x":1368601200000,"y":-5},{"x":1368687600000,"y":-3},{"x":1368774000000,"y":-7},{"x":1368860400000,"y":-4},{"x":1368946800000,"y":-4},{"x":1369033200000,"y":-5},{"x":1369119600000,"y":-6},{"x":1369206000000,"y":-1},{"x":1369292400000,"y":-1},{"x":1369378800000,"y":-6},{"x":1369465200000,"y":-1},{"x":1369551600000,"y":-6},{"x":1369638000000,"y":-2},{"x":1369724400000,"y":-5},{"x":1369810800000,"y":-2},{"x":1369897200000,"y":-5},{"x":1369983600000,"y":-8},{"x":1370070000000,"y":-7},{"x":1370156400000,"y":-4},{"x":1370242800000,"y":-7},{"x":1370329200000,"y":-5},{"x":1370415600000,"y":-2},{"x":1370502000000,"y":-5},{"x":1370588400000,"y":-5},{"x":1370674800000,"y":-4},{"x":1370761200000,"y":-3},{"x":1370847600000,"y":-7},{"x":1370934000000,"y":-11},{"x":1371020400000,"y":-10},{"x":1371106800000,"y":-4}],"borderColor":"#666","color":"#9BD815"},{"name":"More Stuff","data":[{"x":1365836400000,"y":0},{"x":1365922800000,"y":0},{"x":1366009200000,"y":0},{"x":1366095600000,"y":0},{"x":1366182000000,"y":0},{"x":1366268400000,"y":0},{"x":1366354800000,"y":-3},{"x":1366441200000,"y":0},{"x":1366527600000,"y":0},{"x":1366614000000,"y":-1},{"x":1366700400000,"y":0},{"x":1366786800000,"y":0},{"x":1366873200000,"y":0},{"x":1366959600000,"y":0},{"x":1367046000000,"y":0},{"x":1367132400000,"y":0},{"x":1367218800000,"y":-1},{"x":1367305200000,"y":0},{"x":1367391600000,"y":-1},{"x":1367478000000,"y":0},{"x":1367564400000,"y":0},{"x":1367650800000,"y":0},{"x":1367737200000,"y":0},{"x":1367823600000,"y":-1},{"x":1367910000000,"y":0},{"x":1367996400000,"y":-1},{"x":1368082800000,"y":-1},{"x":1368169200000,"y":0},{"x":1368255600000,"y":0},{"x":1368342000000,"y":0},{"x":1368428400000,"y":0},{"x":1368514800000,"y":0},{"x":1368601200000,"y":0},{"x":1368687600000,"y":0},{"x":1368774000000,"y":-5},{"x":1368860400000,"y":0},{"x":1368946800000,"y":0},{"x":1369033200000,"y":-1},{"x":1369119600000,"y":0},{"x":1369206000000,"y":0},{"x":1369292400000,"y":-1},{"x":1369378800000,"y":0},{"x":1369465200000,"y":0},{"x":1369551600000,"y":0},{"x":1369638000000,"y":-7},{"x":1369724400000,"y":-1},{"x":1369810800000,"y":-2},{"x":1369897200000,"y":0},{"x":1369983600000,"y":-1},{"x":1370070000000,"y":0},{"x":1370156400000,"y":0},{"x":1370242800000,"y":0},{"x":1370329200000,"y":-1},{"x":1370415600000,"y":0},{"x":1370502000000,"y":-2},{"x":1370588400000,"y":0},{"x":1370674800000,"y":0},{"x":1370761200000,"y":0},{"x":1370847600000,"y":-2},{"x":1370934000000,"y":-4},{"x":1371020400000,"y":-1},{"x":1371106800000,"y":-3}],"borderColor":"#666","color":"#ff9d48"}],"navigator":{"series":{"type":"area","data":[{"x":1365836400000,"y":3},{"x":1365922800000,"y":3},{"x":1366009200000,"y":4},{"x":1366095600000,"y":5},{"x":1366182000000,"y":5},{"x":1366268400000,"y":7},{"x":1366354800000,"y":7},{"x":1366441200000,"y":5},{"x":1366527600000,"y":2},{"x":1366614000000,"y":7},{"x":1366700400000,"y":3},{"x":1366786800000,"y":7},{"x":1366873200000,"y":5},{"x":1366959600000,"y":8},{"x":1367046000000,"y":3},{"x":1367132400000,"y":1},{"x":1367218800000,"y":5},{"x":1367305200000,"y":8},{"x":1367391600000,"y":10},{"x":1367478000000,"y":9},{"x":1367564400000,"y":7},{"x":1367650800000,"y":2},{"x":1367737200000,"y":3},{"x":1367823600000,"y":7},{"x":1367910000000,"y":3},{"x":1367996400000,"y":8},{"x":1368082800000,"y":7},{"x":1368169200000,"y":7},{"x":1368255600000,"y":3},{"x":1368342000000,"y":4},{"x":1368428400000,"y":7},{"x":1368514800000,"y":6},{"x":1368601200000,"y":6},{"x":1368687600000,"y":6},{"x":1368774000000,"y":13},{"x":1368860400000,"y":5},{"x":1368946800000,"y":4},{"x":1369033200000,"y":6},{"x":1369119600000,"y":10},{"x":1369206000000,"y":5},{"x":1369292400000,"y":4},{"x":1369378800000,"y":9},{"x":1369465200000,"y":1},{"x":1369551600000,"y":6},{"x":1369638000000,"y":10},{"x":1369724400000,"y":9},{"x":1369810800000,"y":6},{"x":1369897200000,"y":10},{"x":1369983600000,"y":14},{"x":1370070000000,"y":8},{"x":1370156400000,"y":4},{"x":1370242800000,"y":9},{"x":1370329200000,"y":11},{"x":1370415600000,"y":4},{"x":1370502000000,"y":13},{"x":1370588400000,"y":8},{"x":1370674800000,"y":5},{"x":1370761200000,"y":4},{"x":1370847600000,"y":10},{"x":1370934000000,"y":18},{"x":1371020400000,"y":16},{"x":1371106800000,"y":9}]}},"xAxis":{"type":"datetime","maxZoom":1209600000}}'
    }
    render text: charts[params[:type].to_s]
  end

  # GET /sandbox/infinite_scroll
  #
  # Demo for InfiniteScroll behavior
  def infinite_scroll
    sleep 0.5
    @offset = params[:offset].to_i || 0
    render layout: false
  end

  # GET /sandbox/poll_for_update
  #
  # Demo for the PollForUpdate behavior
  def poll_for_update
    if params["count"].present?
      new_count = params["count"].to_i + 1
    else
      new_count = 1
    end
    render json: {
      status: "update",
      count: new_count,
      count_text: "#{new_count} new",
      date: params["date"].to_i,
      updated_at: Time.current.to_i
    }.to_json and return
  end

  private

    #
    # Validates that a document requested is actually present in the docs directory;
    # present to prevent fraudulent file system requests. Redirects with a warning
    # if the request is invalid
    #
    # @param dir  [String] The directory within the section files (defined in `get_sandbox_files`); optional
    # @param file [String] The file requested
    #
    def validate_doc_file
      raise "No doc files found; check environment variables for correct paths: #{SANDBOX_DOCS_FULL_PATH}" if @section_files.nil?
      if params[:dir].present?
        if @section_files[params[:dir]].nil? || @section_files[params[:dir]][params[:file]].nil?
          redirect_to sandbox_path, alert: "No page by that name (#{params[:dir]} / #{params[:file]}) found."
          return
        end
      elsif @section_files[params[:file]].nil?
        redirect_to sandbox_path, alert: "No page by that name (#{params[:file]}) found."
        return
      end
    end

    #
    # Gets all the files viewable in the sandbox directory to prevent teh haxxing.
    #
    # @return [Hash] A hash of sections, page names, and their paths. If the item is a directory, its
    #   value will be a similar hash of page/path pairs.
    def get_sandbox_files
      @files = get_files
      @section = params[:section]
      @section_files = @files[@section] if @section
      @dir = params[:dir]
      @file = params[:file]
      @index = params[:index]
      @force_thanxui = true if @section == "CSS" && @dir != "Base"
    end


    #
    # Gets the files in a specific path; recurrsive
    #
    # @param  path=SANDBOX_DOCS_FULL_PATH [String] The base path to search
    #
    # @return see get_sandbox_files
    def get_files(path=nil)
      path = SANDBOX_DOCS_FULL_PATH unless path.present?
      directories = {}
      files = {}
      # get all the files in the path
      Dir.glob("#{path}/*").each do |file|
        next if is_partial?(file)
        page = get_page_name(file)

        # directory? hey, let's do it again!
        if File.directory?(file)
          directories[page] = get_files(file)
        else
          # otherwise we store the page name of the file (the filename w/o the extension)
          # as the key and the path to the file as the value
          files[page] = file.gsub(path + '/', '').gsub('.html.erb', '').gsub('.md', '')
        end
      end
      # merge the files after the directories (so the directories are at the top)
      directories.merge!(files)
      return directories
    end


    #
    # Determines if a file is a partial (i.e. begins with an underscore)
    #
    # @param  file [String] The file path
    #
    # @return [Boolean] True if the file name in the path begins with an underscore.
    def is_partial?(file)
      get_page_name(file)[0] == "_"
    end

    #
    # Gets the display name for a file
    #
    # @param  file [String] the path to a given file in the sandbox
    #
    # @return [String] The file name sans path and extension
    def get_page_name(file)
      file.split("/").last.gsub('.html.erb', '').gsub('.md', '')
    end

    #
    # Destermins which style tag should be used in the layout
    #
    # sets @bootstrap_styles
    def pick_styles
      cookies[:bootstrap_styles] = params[:bootstrap_styles] if params[:bootstrap_styles].present?
      @bootstrap_styles = params[:bootstrap_styles] == "true" || cookies[:bootstrap_styles] == "true"
    end

end
